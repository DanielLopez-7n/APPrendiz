{% extends template_to_extend %}
{% load static %}

{% block title %}Gestión de Bitácora V5 - SENA{% endblock %}

{% block content %}
<style>
    :root {
        --sena-green: #39a900;
        --sena-dark-green: #2d8600;
    }
    
    .text-primary { color: var(--sena-green) !important; }
    .bg-primary { background-color: var(--sena-green) !important; }
    .btn-primary { background-color: var(--sena-green); border-color: var(--sena-green); }
    .btn-primary:hover { background-color: var(--sena-dark-green); border-color: var(--sena-dark-green); }
    
    /* Estilos para el botón de eliminar */
    .btn-delete-row {
        transition: all 0.2s;
    }
    .btn-delete-row:hover {
        background-color: #dc3545;
        color: white !important;
        border-color: #dc3545;
    }

    .card-sena { border-top: 4px solid var(--sena-green); border-radius: 8px; }
    .section-header { background-color: var(--sena-green); color: white; padding: 10px 20px; font-weight: bold; border-radius: 8px 8px 0 0; }
</style>

<div class="container py-5">
    
    <div class="mb-4">
        <a href="{% url 'aprendices:perfil_aprendiz' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Volver al listado
        </a>
    </div>

    <div class="text-center mb-5">
        <h2 class="fw-bold text-primary">{{ titulo }}</h2>
        <p class="text-muted fs-5">Formato Integrado GFPI-F-147</p>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate id="formBitacora">
        {% csrf_token %}

        <div class="card shadow-sm mb-4 card-sena border-0">
            <div class="section-header"><i class="bi bi-1-circle-fill me-2"></i> INFORMACIÓN DEL PERIODO</div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6"><label class="fw-bold">Ficha</label>{{ form.ficha }}</div>
                    <div class="col-md-6"><label class="fw-bold">Instructor</label>{{ form.instructor_seguimiento }}</div>
                    <div class="col-md-4"><label class="fw-bold">Tipo Doc</label>{{ form.tipo_documento }}</div>
                    <div class="col-md-4"><label class="fw-bold">Fecha Inicio</label>{{ form.fecha_inicio }}</div>
                    <div class="col-md-4"><label class="fw-bold">Fecha Fin</label>{{ form.fecha_fin }}</div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-sena border-0">
            <div class="section-header"><i class="bi bi-2-circle-fill me-2"></i> EMPRESA</div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-8"><label class="fw-bold">Razón Social</label>{{ form.razon_social_empresa }}</div>
                    <div class="col-md-4"><label class="fw-bold">NIT</label>{{ form.nit_empresa }}</div>
                    <div class="col-md-12"><label class="fw-bold">Dirección</label>{{ form.direccion_empresa }}</div>
                    <div class="col-12"><hr></div>
                    <div class="col-md-6"><label class="fw-bold">Jefe Inmediato</label>{{ form.nombre_jefe }}</div>
                    <div class="col-md-6"><label class="fw-bold">Cargo</label>{{ form.cargo_jefe }}</div>
                    <div class="col-md-6"><label class="fw-bold">Teléfono</label>{{ form.telefono_jefe }}</div>
                    <div class="col-md-6"><label class="fw-bold">Email</label>{{ form.email_jefe }}</div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-sena border-0">
            <div class="section-header"><i class="bi bi-3-circle-fill me-2"></i> MODALIDAD Y SST</div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-3"><label class="fw-bold">Modalidad</label>{{ form.modalidad }}</div>
                    <div class="col-md-3"><label class="fw-bold">ARL</label>{{ form.afiliado_arl }}</div>
                    <div class="col-md-3"><label class="fw-bold">Riesgo</label>{{ form.nivel_riesgo }}</div>
                    <div class="col-md-3"><label class="fw-bold">EPP</label>{{ form.uso_epp }}</div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-5 border-0" style="border-top: 4px solid #ffc107;">
            <div class="section-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <span><i class="bi bi-4-circle-fill me-2"></i> ACTIVIDADES REALIZADAS</span>
                <button type="button" id="add-activity-btn" class="btn btn-dark btn-sm fw-bold">
                    <i class="bi bi-plus-lg"></i> Agregar Fila
                </button>
            </div>
            
            <div class="card-body p-4 bg-light">
                
                {{ formset.management_form }}

                <div id="activities-container">
                    {% for form_actividad in formset %}
                        <div class="card mb-3 shadow-sm activity-row">
                            <div class="card-body p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-11">
                                        <div class="row g-2">
                                            <div class="col-12">
                                                <label class="small fw-bold text-muted">Descripción</label>
                                                {{ form_actividad.descripcion }}
                                            </div>
                                            <div class="col-md-6">
                                                <label class="small fw-bold text-muted">Fecha</label>
                                                {{ form_actividad.fecha_ejecucion }}
                                            </div>
                                            <div class="col-md-6">
                                                <label class="small fw-bold text-muted">Evidencia</label>
                                                {{ form_actividad.evidencia }}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-1 text-center border-start">
                                        <div class="d-none">
                                            {{ form_actividad.DELETE }} 
                                        </div>
                                        
                                        <button type="button" class="btn btn-outline-danger btn-sm rounded-circle btn-delete-row" title="Eliminar fila">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                        
                                        {% for hidden in form_actividad.hidden_fields %}
                                            {{ hidden }}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <div id="empty-form-template" style="display:none;">
                    <div class="card mb-3 shadow-sm activity-row border-warning">
                        <div class="card-body p-3">
                            <div class="row align-items-center">
                                <div class="col-md-11">
                                    <div class="row g-2">
                                        <div class="col-12">
                                            <label class="small fw-bold text-muted">Descripción</label>
                                            {{ formset.empty_form.descripcion }}
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold text-muted">Fecha</label>
                                            {{ formset.empty_form.fecha_ejecucion }}
                                        </div>
                                        <div class="col-md-6">
                                            <label class="small fw-bold text-muted">Evidencia</label>
                                            {{ formset.empty_form.evidencia }}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 text-center border-start">
                                    <div class="d-none">{{ formset.empty_form.DELETE }}</div>
                                    <button type="button" class="btn btn-outline-danger btn-sm rounded-circle btn-delete-row">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                    {% for hidden in formset.empty_form.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            <a href="{% url 'aprendices:perfil_aprendiz' %}" class="btn btn-secondary px-4 me-2">Cancelar</a>
            <button type="submit" class="btn btn-primary px-5 fw-bold shadow">
                <i class="bi bi-save me-2"></i>Guardar Bitácora
            </button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('activities-container');
        const addBtn = document.getElementById('add-activity-btn');
        const totalFormsInput = document.getElementById('id_actividades-TOTAL_FORMS');
        const emptyTemplate = document.getElementById('empty-form-template').innerHTML;

        // 1. FUNCIÓN PARA AGREGAR FILA
        addBtn.addEventListener('click', function() {
            // Obtener el número actual de formularios
            let count = parseInt(totalFormsInput.value);
            
            // Reemplazar __prefix__ por el número actual (ej: actividades-0, actividades-1)
            const newRowHtml = emptyTemplate.replace(/__prefix__/g, count);
            
            // Insertar en el HTML
            container.insertAdjacentHTML('beforeend', newRowHtml);
            
            // Aumentar el contador de Django
            totalFormsInput.value = count + 1;
        });

        // 2. FUNCIÓN PARA ELIMINAR FILA (Delegación de eventos)
        container.addEventListener('click', function(e) {
            // Buscamos si el click fue en un botón de eliminar (o en su ícono)
            const btn = e.target.closest('.btn-delete-row');
            if (!btn) return; // Si no fue en el botón, no hacemos nada

            const row = btn.closest('.activity-row');
            
            // Buscamos si existe un checkbox de DELETE oculto (significa que la fila ya existe en BD)
            // El nombre suele ser algo como: actividades-0-DELETE
            const deleteCheckbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');

            if (deleteCheckbox) {
                // CASO A: Fila existente en Base de Datos
                // Marcamos el checkbox oculto para que Django la borre al guardar
                deleteCheckbox.checked = true;
                // Ocultamos la fila visualmente
                row.style.display = 'none';
            } else {
                // CASO B: Fila nueva (recién creada con JS)
                // Simplemente la removemos del HTML
                row.remove();
                
                // Opcional: Podríamos actualizar el TOTAL_FORMS, pero Django maneja bien los huecos
            }
        });
    });
</script>
{% endblock %}